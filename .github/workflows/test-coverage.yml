name: Test Coverage

on:
  pull_request:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, xml, curl
          ini-values: post_max_size=256M, upload_max_filesize=256M

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Run tests with coverage
        run: ./vendor/bin/phpunit --coverage-text --whitelist app/Services > coverage.txt || true

      - name: Extract coverage percentage
        run: |
          # Extrai o percentual total
          TOTAL_COVERAGE=$(grep -oP '\d+(?=%)' coverage.txt | head -1)
          if [ -z "$TOTAL_COVERAGE" ]; then
            TOTAL_COVERAGE=0
          fi
          echo "TOTAL_COVERAGE=$TOTAL_COVERAGE" >> $GITHUB_ENV
          echo "Current total coverage is $TOTAL_COVERAGE%"

      - name: Show files with coverage < 80%
        run: |
          echo "Files with coverage below 80%:"
          awk '/^\s+[0-9]+%/ { 
                  split($1, a, "%"); 
                  if (a[1] < 80) print $0 
               }' coverage.txt || true

      - name: Fail if coverage < 80%
        run: |
          if [ "$TOTAL_COVERAGE" -lt 80 ]; then
            echo "❌ Total coverage below 80%!"
            exit 1
          else
            echo "✅ Total coverage is sufficient."
          fi

